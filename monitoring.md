# AWS Monitoring

## CloudWatch Metrics
- Provide metrics for all AWS services like CPU Utilization, Networking...
- Metrics belong tot namespaces
- Dimension is an attribute of a metric (instance id, environment ...)
- Up to 10 dimensions per metric
- Can create CloudWatch dashboard of metrics
- `CloudWatch Basic Monitoring` is enabled by default and collects metric data every 5 mins
- If we want higher rate then enable `CW Detailed Monitoring`

### Custom Metrics
- Possible to define and send your own custom metrics to CW such as EC2 memory usage
- Use API call `PutMetricData`
- Can use dimension to segment metrics
- Metric resolution can be 60 secs or 1/5/10/30 sec (high cost)
- Set resolution by `StorageResolution` API
- It's possible to push metrics 2 weeks in the past or 2 hours in the future without errors
  ```
  aws cloudwatch put-metric-data --metric-name PageViewCount --namespace MyService --value 2 --timestamp 2016-10-20T12:00:00.000Z
  ```
### Resolution
- By default `Basic Monitoring` has an interval of **5 mins**
- `Detailed Monitoring` has an interval of **1 min**
- `Custom Metrics`:
  - `Standard resolution` has an interval of **1 minute**
  - `High resolution` has an interval of **1/5/30/60 seconds**
- `CloudWatch Alarm` can have a max resolution of **10 seconds**

### CloudWatch Logs
- `Log groups`: arbitrary name, usually the app name
- `Log stream`: instances within app/log files/containers
- Can define log expiration policies because by default it never expires
- `Log Retention Policy` can be defined at `Log Group` level
- CloudWatch Logs can send logs to
  - S3
  - Kinesis
  - Lambda 
  - ElasticSearch

#### Sources
- SDK, Logs Agent, Unified Agent can be used to send logs
- Beanstalk collection of logs from apps
- ECS: from containers
- Lambda from fucntion logs
- VPC Flow Logs: VPC specific logs
- API Gateway

#### Metric Filters and Insights
- Use filter expressions to find info from logs
- Can be used to trigger CW alarms
- `Insights` can be used to query logs and add queries to CW `Dashboards`
- To create `Metrics Filter`, go to `Logs` => `Log groups` => select group => `Metric filter` tab => create Metric filter, specify the `Filter pattern`
- This `Metrics Filter` in `Metrics` in `Custom Namespaces` (there has to be metrics logged against it in order for it to show up in Metrics)
  - It's possible to create an alarm out of a `Metrics Filter` by selecting the filter => `Create alarm` => select name, conditions => select `SNS topic` and email to send notifications

### CloudWatch Logs for EC2
- By default, no logs from EC2 going to CW
- Need to run `CW agent` on EC2 to push
- The agent needs `IAM role`
- The agent can be set up on-premises
- There are `CW Logs Agent` (old) and `Unified Agent`(new)
- `Logs Agent` can only send to CW
- `Unified Agent` collects additional system level metrics and sends to CW logs

### CloudWatch Alarms
- 3 stages: `OK`, `INSUFFICIENT_DATA`, `ALARM`
- Period is the length of time in secs to eval the metric, from 10 secs to 1 day or Custom
- Alarm has 3 targets:
  -  Stop/Terminate/Reboot/Recover an EC2 instance
  -  Trigger auto scaling
  -  Send notification to SNS
- CW Alarms can check the status of an EC2 instance, when the underlying hardware failure, it is automatically recovered, it will have the same IP, metadata, placement group
- It's possible to change Alarm stage manually using CLI, useful to test Alarms
### Create a CW Alarm
- Go to `Alarms` => `Create alarm` => `Select Metric` => `EC2` => `Per-instance Metrics (for 1 instance)`
- Select the instance ID => select the metric (CPU Utlization for example)
- Select statistic (avg, sum, max, min...)
- Select check period
- Select Threshold type and the percentage of threshold
- Select `Additional configuration` => `Datapoints to larm`
- If we select threshold = 90, datapoints 3 out of 3 then an alarm will go off when in all 3 checks in 15 mins, the CPU always > 90%
- Click next to select the action if the alarm is raised, it could be sending noti to SNS, notify other accounts
- We can add action for scaling group (to scale up and down) and EC2 instance (terminate or reboot ...) when the alarm goes off

### CloudWatch Events
- Intercept events from AWS services such as EC2 instance start, stop
- Can schedule or Cron events
- Select target so that CW Events can send payloads to like Lambda, ECS task, Batch
- To create an event, go to Events => Rules => Create rule
- Select source like service name, event type or can select Schedule so that an event is created periodically.
- Select target that the event is sent to

## EventBridge
- Next evolution of CW Events
- `Default Event Bus`: generated by AWS services
- `Partner Event Bus`: generated by other SaaS services
- `Custom Event Buses`: for your own apps
- Buses can be accessed from other accounts
- Can set rules on how to process events
- `Even Bridge` can analyze events and infer the schema for them, `Schema Registry` allows you to generate the code for the app thus speed up the development time, it supports popular languages
- Can use IAM to manage the permissions of each event bus to allow, deny events from other regions, accounts

### Create rule
- Go to EventBridge => Create event
- Select event bus (default)
- Select Event source (AWS generated, partner or all)
- Select sample event (ex: EC2 start successfully)
- Select the event pattern and test it against the sample event above
- If it's successful then click Next and select the target, could be email or an AWS service like SNS or SQS
- Go to Schema registry => select the event schema. It will show how the event data looks like and generate code to speed up the development
  
## AWS X-Ray
- Gives visual analysis of apps
- Compatible with many services like Lambda, Beanstalk, ECS, ELB , API Gateway, EC2 or any application server on premises
- Tracing end to end is to follow requests, each service dealing with the requests will add its own "trace"
- Tracing is mande of segments, annotation can be added to traces to provide extra info
- X-Ray can trace any request, secured with IAM for authorization, KMS for encryption at rest

### How to enable X-Ray
- Import AWS SDK
- The SDK will capture API and DB calls
- Install X-Ray daemon or enable X-Ray AWS Integration if on-premises, other AWS services already have the daemon
- The instance must have IAM Role with permission to run, in case of Lambda the execution role must have the proper policy
- On Beanstalk, use `.ebextensions/xray-daemon.config` file to enable

### X-Ray Concepts
- Segments: each application sends them
- Subsegments: more details in segment
- Trace: end to end tracing, combined from all segments
- Sampling: decrease the amount of segments to save cost
- Annotations: Key value pairs, indexed, can be used to filter
- Metadata: Key value pairs, not indexed, cannot be used to filter
- If the X-Ray daemon is config to send traces cross account, make sure the agent has correct role with permissions, this allows 1 account to manage app tracing

### X-Ray Sampling Rules
- More segments = more cost
- Can modify sampling without mod code
- By default, X-Ray records 1st request each second, 5% of any additional requests
- 1 request per sec is the reservoir, which ensures there is at least 1 trace is recorded as long as the service is serving requests
- 5% is the rate of the rest when the reservoir is full (ex: 1 request is already sent)
- Can create rule to set reservoir and rate
- For example:
  - Reservoir 10, rate 0.1 meaning 10 requests and 10% of the others are sent per second to X-Ray
  - Reservoir 1, rate 1 meaning 1 request per sec and 100% of the others are sent to X-Ray which is a lot

### X-Ray API (used by daemon)
- `PutTraceSegments`: upload segment document to X-Ray
- `PutTelemetryRecords`: Used by daemon to upload telemetry
- `GetSamplingRule`: retrieve all sampling rules
- `GetSamplingTarget` & `GetSamplingStatisticSummaries`: advanced stuff
- The daemon needs to have IAM policy authorizing the correct API calls
- `GetServiceGraph`: main graph
- `BatchGetTraces`: retrieve a list of traces with specified ID, each trace is a collection of segments
- `GetTraceSummaries`: retrieve IDs and annotations for traces available for a time frame using an optional filter
- `GetTraceGraph`: retrieves a service graph with specified ID

### X-Ray on Beanstalk
- Add to config file of beanstalk or enable it when creating Beanstalk task
  ```
    option_settings:
        aws:elasticbealnstalk:xray:
            XRayEnabled: true
  ```
- Beanstalk already has daemon but not provided for Multicontainer Docker
- Make sure the instance profile has correct IAM permissions

### X-Ray on ECS
- For EC2 launch type, we need to install deamons
- We can run deamon as sidecar as alternative, which means each app container will have 1 X-Ray sidecar
- For fargate, since we cannot control over EC2 instances, we need to run sidecar

## CloudTrail
- Provide governance, compliance and audit for AWS account
- Enabled by default
- Get history of events/API calls within AWS account
- Can put log into CW or S3
- A trail can be applied to all regions or a single region
- If a resource is deleted, investigate CloudTrail first
- Can only view the events in the last 90 days, older events can be view in logs in S3

### CloudTrail Events
- `Management Events`: operation performed on resources in AWS account, logged
- `Data Events`: not logged, S3 object read write, Lambda function execution
- `CloudTrail Insights Events`: detect unusual activies
  - Inaccurate resource provisioning
  - Hitting service limits
  - Burst of IAM actions
  - Gaps in periodic maintainace activity

### Event Retetion
- By default stored for 90 days
- To keep them, log to S3 or send to Athena